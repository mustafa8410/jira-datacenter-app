<html>
<head>
    <meta charset="UTF-8">
    <title>User Listing</title>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        tr.clickable-row td:not(:first-child) {
            cursor: pointer;
        }

        .table td:first-child,
        .table th:first-child {
            text-align: center; /* Center the checkbox */
        }
        .table td:first-child {
            border-right: 1px solid #dee2e6; /* Bootstrap's default table border color */
        }
    </style>
</head>
<body class="bg-light">
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">User Listing</h4>
                </div>
                <div class="card-body">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                        <tr>
                            <th><input type="checkbox" id="select-all" /></th>
                            <th>Username</th>
                            <th>Display Name</th>
                            <th>Last Login</th>
                            <th class="text-center">Warnings</th> <!-- NEW COLUMN -->
                        </tr>
                        </thead>
                        <tbody>
                            #foreach ($user in $users)

                            <tr class="clickable-row" data-href="/jira/plugins/servlet/my-plugin-user-detail?username=$user.username">
                                <td class="checkbox-column"><input type="checkbox" class="user-checkbox" value="$user.username"></td>
                                <td>$user.username</td>
                                <td>$user.displayName</td>
                                <td>$user.lastLogin</td>
                                <td class="text-center">
                                    #if ($user.warnings && $user.warnings.size() > 0)
                                        <span class="text-warning" data-bs-toggle="tooltip" data-bs-html="true"
                                              title="<ul style='margin:0;padding:0;'>#foreach($w in $user.warnings)<li style='margin-left:-20px;'>$w</li>#end</ul>">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#ffc107" class="bi bi-exclamation-triangle-fill" viewBox="0 0 16 16">
                                                <path d="M8.982 1.566a1.13 1.13 0 0 0-1.964 0L.165 13.233c-.457.778.091 1.767.982 1.767h13.707c.89 0 1.438-.99.982-1.767L8.982 1.566zm-.982 4.905a.905.905 0 1 1 1.81 0l-.35 3.507a.555.555 0 1 1-1.11 0L8 6.471zm.002 5.37a1.25 1.25 0 1 1 2.498 0 1.25 1.25 0 0 1-2.498 0z"/>
                                            </svg>
                                        </span>
                                    #end
                                </td>

                            </tr>
                            #end
                        </tbody>

                    </table>

                    <form id="bulkForm" method="post" action="/jira/plugins/servlet/bulk-action"></form>

                    <!-- Seçilen kullanıcıları göstermek için buton -->
                    <div class="mt-3 text-end">
                        <button class="btn btn-outline-primary" onclick="getSelectedUsernames()">Seçilenleri Göster</button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll("tr.clickable-row").forEach(row => {
            row.addEventListener("click", function (e) {
                const cb = this.querySelector("input.user-checkbox");

                // If click is inside the first cell (checkbox area)
                if (e.target.closest("td:first-child")) {
                    // If the actual checkbox itself was clicked, do nothing (let browser handle it)
                    if (e.target === cb) {
                        e.stopPropagation(); // Just stop row navigation
                        return;
                    }

                    // Otherwise, toggle checkbox manually (clicked outside the box but inside cell)
                    cb.checked = !cb.checked;
                    this.classList.toggle("selected-row", cb.checked);
                    e.stopPropagation(); // Prevent row navigation
                    return;
                }

                // For clicks on other cells, open detail page
                window.open(this.dataset.href, "_blank");
            });


        });

        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        tooltipTriggerList.forEach(function (tooltipTriggerEl) {
            new bootstrap.Tooltip(tooltipTriggerEl)
        });



        // "Tümünü seç" checkbox'ı
        document.getElementById("select-all").addEventListener("change", function () {
            const allCheckboxes = document.querySelectorAll(".user-checkbox");
            allCheckboxes.forEach(cb => {
                cb.checked = this.checked;
                cb.closest("tr").classList.toggle("selected-row", this.checked);
            });
        });

        // Satır seçiliyse arka plan rengini değiştir
        document.querySelectorAll(".user-checkbox").forEach(cb => {
            cb.addEventListener("change", function () {
                this.closest("tr").classList.toggle("selected-row", this.checked);
            });
        });
    });

    // Seçilen kullanıcıların username'lerini göster
    function getSelectedUsernames() {
        const form = document.getElementById("bulkForm");
        form.innerHTML = ""; // önceki input'ları temizle

        const selected = Array.from(document.querySelectorAll(".user-checkbox:checked"))
            .map(cb => cb.value);

        if (selected.length === 0) {
            alert("Lütfen en az bir kullanıcı seçin.");
            return;
        }

        // Seçilen kullanıcıları form içine ekle
        selected.forEach(username => {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = "selectedUsers";
            input.value = username;
            form.appendChild(input);
    });

    form.submit(); // formu sunucuya gönder
}
    // Bootstrap 5 tooltip enable (for dynamically created tooltips)




</script>

</body>
</html>
