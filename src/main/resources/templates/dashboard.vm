<html>
<head>
    <meta charset="UTF-8">
    <title>User Listing</title>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        tr.clickable-row td:not(:first-child) {
            cursor: pointer;
        }

        .table td:first-child,
        .table th:first-child {
            text-align: center; /* Center the checkbox */
        }
        .table td:first-child {
            border-right: 1px solid #dee2e6; /* Bootstrap's default table border color */
        }
    </style>
</head>
<body class="bg-light">
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">User Listing</h4>
                </div>
                <div class="card-body">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                        <tr>
                            <th><input type="checkbox" id="select-all" /></th> <!-- Tümünü Seç checkbox -->
                            <th>Username</th>
                            <th>Display Name</th>
                            <th>Last Login</th>
                        </tr>
                        </thead>
                        <tbody>
                            #foreach ($user in $users)
                            <tr class="clickable-row" data-href="/jira/plugins/servlet/my-plugin-user-detail?username=$user.username">
                                <td class="checkbox-column"><input type="checkbox" class="user-checkbox" value="$user.username"></td>
                                <td>$user.username</td>
                                <td>$user.displayName</td>
                                <td>$user.lastLogin</td>
                            </tr>
                            #end
                        </tbody>
                    </table>

                    <form id="bulkForm" method="post" action="/jira/plugins/servlet/bulk-action"></form>

                    <!-- Seçilen kullanıcıları göstermek için buton -->
                    <div class="mt-3 text-end">
                        <button class="btn btn-outline-primary" onclick="getSelectedUsernames()">Seçilenleri Göster</button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll("tr.clickable-row").forEach(row => {
            row.addEventListener("click", function (e) {
                const cb = this.querySelector("input.user-checkbox");

                // If click is inside the first cell (checkbox area)
                if (e.target.closest("td:first-child")) {
                    // If the actual checkbox itself was clicked, do nothing (let browser handle it)
                    if (e.target === cb) {
                        e.stopPropagation(); // Just stop row navigation
                        return;
                    }

                    // Otherwise, toggle checkbox manually (clicked outside the box but inside cell)
                    cb.checked = !cb.checked;
                    this.classList.toggle("selected-row", cb.checked);
                    e.stopPropagation(); // Prevent row navigation
                    return;
                }

                // For clicks on other cells, open detail page
                window.open(this.dataset.href, "_blank");
            });
        });



        // "Tümünü seç" checkbox'ı
        document.getElementById("select-all").addEventListener("change", function () {
            const allCheckboxes = document.querySelectorAll(".user-checkbox");
            allCheckboxes.forEach(cb => {
                cb.checked = this.checked;
                cb.closest("tr").classList.toggle("selected-row", this.checked);
            });
        });

        // Satır seçiliyse arka plan rengini değiştir
        document.querySelectorAll(".user-checkbox").forEach(cb => {
            cb.addEventListener("change", function () {
                this.closest("tr").classList.toggle("selected-row", this.checked);
            });
        });
    });

    // Seçilen kullanıcıların username'lerini göster
    function getSelectedUsernames() {
        const form = document.getElementById("bulkForm");
        form.innerHTML = ""; // önceki input'ları temizle

        const selected = Array.from(document.querySelectorAll(".user-checkbox:checked"))
            .map(cb => cb.value);

        if (selected.length === 0) {
            alert("Lütfen en az bir kullanıcı seçin.");
            return;
        }

        // Seçilen kullanıcıları form içine ekle
        selected.forEach(username => {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = "selectedUsers";
            input.value = username;
            form.appendChild(input);
    });

    form.submit(); // formu sunucuya gönder
}

</script>

</body>
</html>
