<html>
<head>
    <meta charset="UTF-8">
    <title>User Listing</title>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        tr.clickable-row td:not(:first-child) {
            cursor: pointer;
        }

        .table td:first-child,
        .table th:first-child {
            text-align: center; /* Center the checkbox */
        }
        .table td:first-child {
            border-right: 1px solid #dee2e6; /* Bootstrap's default table border color */
        }
    </style>
</head>
<body class="bg-light">
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">User Listing</h4>
                </div>
                <div class="card-body">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                        <tr>
                            <th><input type="checkbox" id="select-all" /></th>
                            <th>Username</th>
                            <th>Display Name</th>
                            <th>Last Login</th>
                            <th class="text-center">Warnings</th> <!-- NEW COLUMN -->
                        </tr>
                        </thead>
                        <tbody>
                            #foreach ($user in $users)

                            <tr class="clickable-row" data-href="/jira/plugins/servlet/my-plugin-user-detail?username=$user.username">
                                <td class="checkbox-column"><input type="checkbox" class="user-checkbox" value="$user.username"></td>
                                <td>$user.username</td>
                                <td>$user.displayName</td>
                                <td>$user.lastLogin</td>
                                <td class="text-center">
                                    #if ($user.warnings && $user.warnings.size() > 0)
                                        <span class="text-warning" data-bs-toggle="tooltip" data-bs-html="true"
                                              title="<ul style='margin:0;padding:0;'>#foreach($w in $user.warnings)<li style='margin-left:-20px;'>$w</li>#end</ul>">
                                            <!-- Custom SVG icon (Font Awesome Triangle Exclamation, bright yellow) -->
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="22" height="22" style="vertical-align:middle;">
                                                <path fill="#FFD43B" d="M320 64C334.7 64 348.2 72.1 355.2 85L571.2 485C577.9 497.4 577.6 512.4 570.4 524.5C563.2 536.6 550.1 544 536 544L104 544C89.9 544 76.9 536.6 69.6 524.5C62.3 512.4 62.1 497.4 68.8 485L284.8 85C291.8 72.1 305.3 64 320 64zM320 232C306.7 232 296 242.7 296 256L296 368C296 381.3 306.7 392 320 392C333.3 392 344 381.3 344 368L344 256C344 242.7 333.3 232 320 232zM346.7 448C347.3 438.1 342.4 428.7 333.9 423.5C325.4 418.4 314.7 418.4 306.2 423.5C297.7 428.7 292.8 438.1 293.4 448C292.8 457.9 297.7 467.3 306.2 472.5C314.7 477.6 325.4 477.6 333.9 472.5C342.4 467.3 347.3 457.9 346.7 448z"/>
                                            </svg>
                                        </span>
                                    #end
                                </td>


                            </tr>
                            #end
                        </tbody>

                    </table>

                    <form id="bulkForm" method="post" action="/jira/plugins/servlet/bulk-action"></form>

                    <!-- Seçilen kullanıcıları göstermek için buton -->
                    <div class="mt-3 text-end">
                        <button class="btn btn-outline-primary" onclick="getSelectedUsernames()">Seçilenleri Göster</button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll("tr.clickable-row").forEach(row => {
            row.addEventListener("click", function (e) {
                const cb = this.querySelector("input.user-checkbox");

                // If click is inside the first cell (checkbox area)
                if (e.target.closest("td:first-child")) {
                    // If the actual checkbox itself was clicked, do nothing (let browser handle it)
                    if (e.target === cb) {
                        e.stopPropagation(); // Just stop row navigation
                        return;
                    }

                    // Otherwise, toggle checkbox manually (clicked outside the box but inside cell)
                    cb.checked = !cb.checked;
                    this.classList.toggle("selected-row", cb.checked);
                    e.stopPropagation(); // Prevent row navigation
                    return;
                }

                // For clicks on other cells, open detail page
                window.open(this.dataset.href, "_blank");
            });


        });

        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        tooltipTriggerList.forEach(function (tooltipTriggerEl) {
            new bootstrap.Tooltip(tooltipTriggerEl)
        });



        // "Tümünü seç" checkbox'ı
        document.getElementById("select-all").addEventListener("change", function () {
            const allCheckboxes = document.querySelectorAll(".user-checkbox");
            allCheckboxes.forEach(cb => {
                cb.checked = this.checked;
                cb.closest("tr").classList.toggle("selected-row", this.checked);
            });
        });

        // Satır seçiliyse arka plan rengini değiştir
        document.querySelectorAll(".user-checkbox").forEach(cb => {
            cb.addEventListener("change", function () {
                this.closest("tr").classList.toggle("selected-row", this.checked);
            });
        });
    });

    // Seçilen kullanıcıların username'lerini göster
    function getSelectedUsernames() {
        const form = document.getElementById("bulkForm");
        form.innerHTML = ""; // önceki input'ları temizle

        const selected = Array.from(document.querySelectorAll(".user-checkbox:checked"))
            .map(cb => cb.value);

        if (selected.length === 0) {
            alert("Lütfen en az bir kullanıcı seçin.");
            return;
        }

        // Seçilen kullanıcıları form içine ekle
        selected.forEach(username => {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = "selectedUsers";
            input.value = username;
            form.appendChild(input);
    });

    form.submit(); // formu sunucuya gönder
}
    // Bootstrap 5 tooltip enable (for dynamically created tooltips)




</script>

</body>
</html>
