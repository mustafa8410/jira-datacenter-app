<html>
<head>
    <meta charset="UTF-8">
    <title>Confirm Bulk Action</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .user-list { max-height: 480px; overflow: auto; }
        .pagination { margin-top: 12px; }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    </style>
</head>
<body class="bg-light">
<div class="container my-5">
    <div class="card shadow-sm">
        <div class="card-header bg-warning">
            <h4 class="mb-0 text-dark">Please Confirm Bulk Action</h4>
        </div>
        <div class="card-body">
            <p class="mb-2">
                <strong>Action:</strong>
                #if($action == "remove-group") <span class="badge bg-danger">Revoke License (Remove from Group)</span>
                #else <span class="badge bg-secondary">$action</span>
                #end
            </p>
            <p class="mb-3">
                <strong>Total users affected:</strong>
                <span class="badge bg-dark">$users.size()</span>
            </p>

            <div class="mb-2 d-flex align-items-center">
                <label class="me-2">Rows per page:</label>
                <select id="pageSize" class="form-select form-select-sm" style="width:auto;">
                    <option>25</option>
                    <option selected>50</option>
                    <option>100</option>
                </select>
            </div>

            <div id="list" class="list-group user-list">
                #foreach($u in $users)
                    <div class="list-group-item d-flex justify-content-between align-items-center user-row" data-username="$u.name">
                        <div>
                            <span class="fw-semibold">$u.displayName</span>
                            <span class="text-muted mono">($u.name)</span>
                        </div>
                    </div>
                #end
            </div>

            <nav class="mt-2">
                <ul id="pager" class="pagination justify-content-center"></ul>
            </nav>

            <div class="alert alert-danger mt-3" role="alert">
                This action cannot be undone. Are you sure you want to proceed?
            </div>

            <div class="d-flex justify-content-between mt-3">
                <a href="$contextPath/plugins/servlet/my-plugin-dashboard" class="btn btn-outline-secondary">Back to Dashboard</a>

                <form method="post" action="$contextPath/plugins/servlet/bulk-action" id="confirmForm">
                    <input type="hidden" name="confirm" value="1"/>
                    <input type="hidden" name="action" value="$action"/>
                    <input type="hidden" name="selectionMode" value="$selectionMode"/>
                    ## Echo back the selection arrays
                    #foreach($s in $selectedUsers)
                        <input type="hidden" name="selectedUsers" value="$s"/>
                    #end
                    #foreach($e in $exclude)
                        <input type="hidden" name="exclude" value="$e"/>
                    #end

                    <button type="submit" class="btn btn-danger">Proceed & Revoke</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {

        // Client-side pagination
        const rows = Array.from(document.querySelectorAll('.user-row'));
        const pager = document.getElementById('pager');
        const pageSizeSel = document.getElementById('pageSize');

        function render(page, pageSize) {
            const total = rows.length;
            const pages = Math.max(1, Math.ceil(total / pageSize));
            if (page < 1) page = 1;
            if (page > pages) page = pages;

            rows.forEach((el, idx) => {
                const start = (page - 1) * pageSize;
                const end = start + pageSize;
                el.style.display = (idx >= start && idx < end) ? '' : 'none';
            });

            pager.innerHTML = '';
            // Prev
            pager.appendChild(pageItem('Prev', page > 1 ? page - 1 : null));
            // Window
            const win = 2, from = Math.max(1, page - win), to = Math.min(pages, page + win);
            if (from > 1) pager.appendChild(disabledItem('...'));
            for (let p = from; p <= to; p++) {
                pager.appendChild(pageItem(String(p), p === page ? null : p, p === page));
            }
            if (to < pages) pager.appendChild(disabledItem('...'));
            // Next
            pager.appendChild(pageItem('Next', page < pages ? page + 1 : null));

            pager.dataset.page = String(page);
            pager.dataset.pages = String(pages);
        }

        function pageItem(label, gotoPage, active) {
            const li = document.createElement('li');
            li.className = 'page-item' + (active ? ' active disabled' : '') + (gotoPage ? '' : ' disabled');
            const a = document.createElement('a');
            a.className = 'page-link';
            a.href = '#';
            a.textContent = label;
            if (gotoPage) {
                a.addEventListener('click', function (e) {
                    e.preventDefault();
                    render(gotoPage, parseInt(pageSizeSel.value, 10));
                });
            }
            li.appendChild(a);
            return li;
        }

        function disabledItem(text) {
            const li = document.createElement('li');
            li.className = 'page-item disabled';
            const span = document.createElement('span');
            span.className = 'page-link';
            span.textContent = text;
            li.appendChild(span);
            return li;
        }

        pageSizeSel.addEventListener('change', function () {
            render(1, parseInt(this.value, 10));
        });

        render(1, parseInt(pageSizeSel.value, 10));
    })();
</script>
</body>
</html>
